<!-- index.html (enhanced) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Interview Avatar – Upload Flow</title>
  <style>
    body,html{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#f7f7f7}
    #duix-container{width:100vw;height:60vh;border:2px dashed #2ecc71;margin-bottom:12px}
    .panel{max-width:640px;margin:12px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .row{display:flex;gap:12px;margin-bottom:14px}
    input[type=file]{flex:1}
    button{padding:10px 18px;border:none;border-radius:4px;background:#166aff;color:#fff;cursor:pointer}
  </style>
  <script src="https://cdn.guiji.ai/duix/sdk/0.2.1/duix.js"></script>
</head>
<body>
  <div class="panel">
    <h2 style="margin-top:0">AI Interview Demo</h2>
    <div class="row">
      <label>Conversation&nbsp;ID&nbsp;</label>
      <input id="cid" value="1933895643556687874" style="flex:1" />
    </div>
    <div class="row">
      <input id="resume"    type="file" accept=".pdf,.txt,.doc,.docx" />
      <input id="jd"        type="file" accept=".pdf,.txt,.doc,.docx" />
    </div>
    <button id="start">Start Interview</button>
  </div>
  <div id="duix-container"></div>

<script type="module">
const startBtn = document.getElementById('start');
const duix     = new window.DUIX();

const getSign = async (cid)=>{
  const r = await fetch(`/api/duix/sign?conversationId=${encodeURIComponent(cid)}`);
  if(!r.ok) throw new Error(await r.text());
  return (await r.json()).sign;
};

startBtn.onclick = async ()=>{
  const conversationId = document.getElementById('cid').value.trim();
  if(!conversationId) return alert('Conversation-ID required');

  // 1️⃣ gather files
  const resumeFile = document.getElementById('resume').files[0];
  const jdFile     = document.getElementById('jd').files[0];
  if(!resumeFile || !jdFile) return alert('Please upload Resume and Job-Description');

  // 2️⃣ upload to backend – receives parsed text, returns {resumeText, jdText}
  const fd = new FormData();
  fd.append('resume', resumeFile);
  fd.append('jd',     jdFile);
  fd.append('conversationId', conversationId);
  const prep = await fetch('/api/upload', {method:'POST',body:fd});
  if(!prep.ok) return alert('upload failed');
  const {resumeText,jdText} = await prep.json();

  // 3️⃣ fetch sign
  const sign = await getSign(conversationId);

  // 4️⃣ tell duix to inject the context BEFORE start
  duix.on('initialSuccess', ()=>duix.start({openAsr:true}).catch(console.error));

  duix.init({
    sign,
    conversationId,
    containerLable:'#duix-container',
    platform:'duix.com',
    // custom businessData becomes LLM context
    businessData:{resume:resumeText,jd:jdText}
  }).catch(console.error);
};
</script>
</body>
</html>